name: Robot Framework CI

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment (sandbox/prod)"
        required: true
        default: "sandbox"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  robot-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Robot Framework tests
        env:
          CI: "true"
          BROWSER: chrome
          HEADLESS: "true"
        run: |
          python run_tests.py ${{ github.event.inputs.environment || 'sandbox' }}

      # Debug - Listar archivos generados
      - name: Debug - List all results
        if: always()
        run: |
          echo "=== ESTRUCTURA DE DIRECTORIOS ==="
          ls -la results/
          echo "=== DIRECTORIO EXECUTIONS ==="
          ls -la results/executions/ || true
          echo "=== BUSCANDO ARCHIVOS LATEST ==="
          find results -name "latest.txt" -type f | head -5
          echo "=== CONTENIDO DE LOS ARCHIVOS LATEST ==="
          find results -name "latest.txt" -type f -exec cat {} \; -exec echo "" \;
          echo "=== ARCHIVOS HTML ENCONTRADOS ==="
          find results -name "*.html" | head -20
          echo "=== ARCHIVOS PNG ENCONTRADOS ==="
          find results -name "*.png" | head -20

      # Generar reporte Allure
      - name: Build Allure Report
        if: always()
        uses: simple-elf/allure-report-action@master
        with:
          allure_results: results/allure-results

      # Preparar contenido para GitHub Pages
      - name: Prepare GitHub Pages content
        if: always()
        run: |
          mkdir -p public

          echo "Copiando dashboard..."
          if [ -d "pages" ]; then
            cp -r pages/* public/ 2>/dev/null || true
            echo "âœ… Dashboard copiado"
          fi

          echo "Copiando reporte de Allure..."
          if [ -d "allure-report" ]; then
            mkdir -p public/allure
            cp -r allure-report/* public/allure/ 2>/dev/null || true
            echo "âœ… Allure report copiado a public/allure/"
          else
            echo "âŒ No se encontrÃ³ allure-report"
          fi

          echo "Copiando reportes de Robot Framework..."
          mkdir -p public/robot

          # Buscar el archivo latest.txt en la estructura correcta
          LATEST_FILE=""
          if [ -f "results/executions/latest.txt" ]; then
            LATEST_FILE="results/executions/latest.txt"
          elif [ -f "results/latest.txt" ]; then
            LATEST_FILE="results/latest.txt"
          else
            LATEST_FILE=$(find results -name "latest.txt" -type f | head -1)
          fi

          if [ -n "$LATEST_FILE" ] && [ -f "$LATEST_FILE" ]; then
            LATEST=$(cat "$LATEST_FILE")
            echo "ðŸ“ Ãšltima ejecuciÃ³n (desde $LATEST_FILE): $LATEST"
            cp "$LATEST_FILE" public/latest.txt
            
            # Verificar si la ruta en latest.txt es relativa o absoluta
            if [ ! -d "$LATEST" ] && [ -d "results/executions/$(basename "$LATEST")" ]; then
              LATEST="results/executions/$(basename "$LATEST")"
              echo "ðŸ“ Ruta ajustada: $LATEST"
            fi
            
            if [ -d "$LATEST" ]; then
              echo "âœ… Directorio encontrado: $LATEST"
              
              # Obtener el nombre del directorio
              DIR_NAME=$(basename "$LATEST")
              
              # Copiar TODO el contenido de la Ãºltima ejecuciÃ³n a /robot/latest/
              echo "Copiando Ãºltima ejecuciÃ³n a public/robot/latest/"
              mkdir -p public/robot/latest
              cp -r "$LATEST"/* public/robot/latest/ 2>/dev/null || true
              
              # Copiar archivos individuales a la raÃ­z para acceso directo
              if [ -f "$LATEST/report.html" ]; then
                cp "$LATEST/report.html" public/robot/report.html
                echo "âœ… report.html copiado a raÃ­z"
              fi
              if [ -f "$LATEST/log.html" ]; then
                cp "$LATEST/log.html" public/robot/log.html
                echo "âœ… log.html copiado a raÃ­z"
              fi
              if [ -f "$LATEST/output.xml" ]; then
                cp "$LATEST/output.xml" public/robot/output.xml
              fi
              
              # Verificar screenshots
              if [ -d "$LATEST/screenshots" ]; then
                echo "âœ… Directorio screenshots encontrado"
                mkdir -p public/robot/latest/screenshots
                cp -r "$LATEST/screenshots"/* public/robot/latest/screenshots/ 2>/dev/null || true
                echo "   Screenshots copiados: $(ls -1 public/robot/latest/screenshots/ 2>/dev/null | wc -l)"
              fi
              
              # Copiar cualquier PNG suelto
              find "$LATEST" -name "*.png" -type f -exec cp {} public/robot/latest/ \; 2>/dev/null || true
              
              # Crear archivo HTML de redirecciÃ³n
              cat > public/robot/index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
              <meta http-equiv="refresh" content="0; url=./latest/report.html">
              <title>Robot Framework Reports</title>
          </head>
          <body>
              <p>Redirigiendo al <a href="./latest/report.html">Ãºltimo reporte</a>...</p>
          </body>
          </html>
          EOF
                        echo "âœ… RedirecciÃ³n creada en public/robot/index.html"
                        
                      else
                        echo "âŒ El directorio $LATEST no existe"
                      fi
                    else
                      echo "âŒ No se encontrÃ³ archivo latest.txt"
            
            # Fallback: buscar el directorio mÃ¡s reciente con report.html
            echo "Buscando el directorio mÃ¡s reciente con report.html..."
            LATEST_DIR=$(find results/executions -name "report.html" -type f | xargs dirname | sort -r | head -1)
            
            if [ -n "$LATEST_DIR" ] && [ -d "$LATEST_DIR" ]; then
              echo "âœ… Usando directorio mÃ¡s reciente: $LATEST_DIR"
              DIR_NAME=$(basename "$LATEST_DIR")
              
              mkdir -p public/robot/latest
              cp -r "$LATEST_DIR"/* public/robot/latest/ 2>/dev/null || true
              cp "$LATEST_DIR/report.html" public/robot/report.html 2>/dev/null || true
              cp "$LATEST_DIR/log.html" public/robot/log.html 2>/dev/null || true
              
              if [ -d "$LATEST_DIR/screenshots" ]; then
                mkdir -p public/robot/latest/screenshots
                cp -r "$LATEST_DIR/screenshots"/* public/robot/latest/screenshots/ 2>/dev/null || true
              fi
              
              cat > public/robot/index.html << EOF
            <!DOCTYPE html>
            <html>
            <head>
                <meta http-equiv="refresh" content="0; url=./latest/report.html">
                <title>Robot Framework Reports</title>
            </head>
            <body>
                <p>Redirigiendo al <a href="./latest/report.html">Ãºltimo reporte</a>...</p>
            </body>
            </html>
            EOF
                        fi
                      fi

          # BÃºsqueda global de PNGs
          echo "=== BUSCANDO ARCHIVOS PNG ==="
          PNG_COUNT=0
          mkdir -p public/robot/all_screenshots
          find results -name "*.png" -type f | while read png; do
            cp "$png" public/robot/all_screenshots/ 2>/dev/null && PNG_COUNT=$((PNG_COUNT + 1))
          done
          echo "âœ… $PNG_COUNT PNGs copiados a public/robot/all_screenshots/"

          # VerificaciÃ³n final
          echo "=== VERIFICACIÃ“N FINAL ==="
          echo "Contenido de public/robot:"
          ls -la public/robot/
          echo ""
          echo "Contenido de public/robot/latest:"
          if [ -d "public/robot/latest" ]; then
            ls -la public/robot/latest/ | head -10
            echo "Total archivos en latest: $(ls -1 public/robot/latest/ | wc -l)"
          else
            echo "No hay directorio latest"
          fi
          echo ""
          echo "Total PNGs: $(find public/robot -name "*.png" -type f | wc -l)"

      # Deploy a GitHub Pages
      - name: Deploy Reports
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public
          publish_branch: gh-pages
          force_orphan: true
