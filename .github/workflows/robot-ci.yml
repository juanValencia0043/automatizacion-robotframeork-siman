name: Robot Framework CI

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment (sandbox/prod)"
        required: true
        default: "sandbox"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  robot-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Robot Framework tests
        env:
          CI: "true"
          BROWSER: chrome
          HEADLESS: "true"
        run: |
          python run_tests.py ${{ github.event.inputs.environment || 'sandbox' }}

      # Debug - Listar archivos generados
      - name: Debug - List all results
        if: always()
        run: |
          echo "=== ESTRUCTURA DE DIRECTORIOS ==="
          ls -la results/
          echo "=== DIRECTORIO EXECUTIONS ==="
          ls -la results/executions/ || true
          echo "=== CONTENIDO DE results/executions/latest.txt ==="
          cat results/executions/latest.txt 2>/dev/null || echo "No existe latest.txt"
          echo "=== ARCHIVOS HTML ENCONTRADOS ==="
          find results -name "*.html" | head -20

      # Generar reporte Allure
      - name: Build Allure Report
        if: always()
        uses: simple-elf/allure-report-action@master
        with:
          allure_results: results/allure-results

      # Preparar contenido para GitHub Pages
      - name: Prepare GitHub Pages content
        if: always()
        run: |
          mkdir -p public
          
          echo "Copiando dashboard..."
          cp -r pages/* public/ || true
          
          echo "Copiando reporte de Allure..."
          if [ -d "allure-report" ]; then
            cp -r allure-report public/allure
            echo "âœ… Allure report copiado"
          else
            echo "âŒ No se encontrÃ³ allure-report"
          fi
          
          echo "Copiando reporte de Robot Framework..."
          mkdir -p public/robot
          
          # Verificar si existe el archivo latest.txt
          if [ -f results/executions/latest.txt ]; then
            LATEST=$(cat results/executions/latest.txt)
            echo "ðŸ“ Ãšltima ejecuciÃ³n: $LATEST"
            
            # Copiar latest.txt a public para referencia
            cp results/executions/latest.txt public/latest.txt
            
            # Verificar si el directorio existe
            if [ -d "$LATEST" ]; then
              echo "âœ… Directorio encontrado: $LATEST"
              
              # Listar contenido para depuraciÃ³n
              echo "Contenido del directorio:"
              ls -la "$LATEST"
              
              # Copiar todos los archivos HTML al directorio robot
              cp "$LATEST"/*.html public/robot/ || true
              
              # TambiÃ©n copiar a la raÃ­z de robot para fÃ¡cil acceso
              if [ -f "$LATEST/report.html" ]; then
                cp "$LATEST/report.html" public/robot/report.html
                echo "âœ… Reporte copiado: public/robot/report.html"
              else
                echo "âŒ No se encontrÃ³ report.html en $LATEST"
              fi
              
              if [ -f "$LATEST/log.html" ]; then
                cp "$LATEST/log.html" public/robot/log.html
                echo "âœ… Log copiado: public/robot/log.html"
              else
                echo "âŒ No se encontrÃ³ log.html en $LATEST"
              fi
              
              if [ -f "$LATEST/output.xml" ]; then
                cp "$LATEST/output.xml" public/robot/output.xml
                echo "âœ… Output.xml copiado"
              fi
            else
              echo "âŒ El directorio $LATEST no existe"
              echo "Buscando ejecuciones disponibles:"
              find results/executions -name "*.html" -type f | head -5
            fi
          else
            echo "âŒ No se encontrÃ³ results/executions/latest.txt"
            echo "Buscando archivos HTML en results/executions:"
            find results/executions -name "*.html" -type f | head -10
            
            # Fallback: buscar cualquier report.html en results
            echo "=== BUSCANDO REPORTES FALLBACK ==="
            REPORT_FILE=$(find results -name "report.html" -type f | head -1)
            if [ -n "$REPORT_FILE" ]; then
              echo "âœ… Encontrado reporte fallback: $REPORT_FILE"
              cp "$REPORT_FILE" public/robot/report.html
              # TambiÃ©n buscar log.html en el mismo directorio
              LOG_FILE=$(dirname "$REPORT_FILE")/log.html
              if [ -f "$LOG_FILE" ]; then
                cp "$LOG_FILE" public/robot/log.html
              fi
            fi
          fi
          
          # Crear archivo de Ã­ndice para verificaciÃ³n
          echo "Archivos en public/robot:" > public/robot/files.txt
          ls -la public/robot/ >> public/robot/files.txt
          
          # Verificar que los archivos se copiaron
          echo "=== VERIFICACIÃ“N FINAL ==="
          echo "Contenido de public/robot:"
          ls -la public/robot/

      # Deploy a GitHub Pages
      - name: Deploy Reports
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public
          publish_branch: gh-pages
          force_orphan: true