name: Robot Framework CI

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment (sandbox/prod)"
        required: true
        default: "sandbox"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  robot-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Robot Framework tests
        env:
          CI: "true"
          BROWSER: chrome
          HEADLESS: "true"
        run: |
          python run_tests.py ${{ github.event.inputs.environment || 'sandbox' }}

      # Debug - Listar archivos generados
      - name: Debug - List all results
        if: always()
        run: |
          echo "=== ESTRUCTURA DE DIRECTORIOS ==="
          ls -la results/
          echo "=== DIRECTORIO EXECUTIONS ==="
          ls -la results/executions/ || true
          echo "=== CONTENIDO DE results/executions/latest.txt ==="
          cat results/executions/latest.txt 2>/dev/null || echo "No existe latest.txt"
          echo "=== ARCHIVOS HTML ENCONTRADOS ==="
          find results -name "*.html" | head -20

      # Generar reporte Allure
      - name: Build Allure Report
        if: always()
        uses: simple-elf/allure-report-action@master
        with:
          allure_results: results/allure-results

      # Preparar contenido para GitHub Pages
      - name: Prepare GitHub Pages content
        if: always()
        run: |
          mkdir -p public
          
          echo "Copiando dashboard..."
          cp -r pages/* public/ || true
          
          echo "Copiando reporte de Allure..."
          if [ -d "allure-report" ]; then
            cp -r allure-report public/allure
            echo "âœ… Allure report copiado"
          else
            echo "âŒ No se encontrÃ³ allure-report"
          fi
          
          echo "Copiando reporte de Robot Framework..."
          mkdir -p public/robot
          
          # Verificar si existe el archivo latest.txt
          if [ -f results/executions/latest.txt ]; then
            LATEST=$(cat results/executions/latest.txt)
            echo "ðŸ“ Ãšltima ejecuciÃ³n: $LATEST"
            
            # Copiar latest.txt a public para referencia
            cp results/executions/latest.txt public/latest.txt
            
            # Verificar si el directorio existe
            if [ -d "$LATEST" ]; then
              echo "âœ… Directorio encontrado: $LATEST"
              
              # Listar contenido para depuraciÃ³n
              echo "Contenido del directorio:"
              ls -la "$LATEST"
              
              # IMPORTANTE: Copiar TODO el contenido del directorio (incluyendo screenshots)
              echo "Copiando todos los archivos y directorios..."
              cp -r "$LATEST"/* public/robot/ 2>/dev/null || true
              
              # Verificar especÃ­ficamente los screenshots
              if [ -d "$LATEST/screenshots" ]; then
                echo "âœ… Directorio de screenshots encontrado"
                mkdir -p public/robot/screenshots
                cp -r "$LATEST/screenshots"/* public/robot/screenshots/ 2>/dev/null || true
                echo "Screenshots copiados: $(ls -la public/robot/screenshots/ | wc -l) archivos"
              else
                echo "âŒ No se encontrÃ³ directorio de screenshots en $LATEST"
                # Buscar screenshots en otras ubicaciones
                find results -name "*.png" -type f | head -10
              fi
              
              # TambiÃ©n copiar cualquier archivo PNG que estÃ© en el directorio raÃ­z
              find "$LATEST" -name "*.png" -type f -exec cp {} public/robot/ \; 2>/dev/null || true
              
            else
              echo "âŒ El directorio $LATEST no existe"
            fi
          else
            echo "âŒ No se encontrÃ³ results/executions/latest.txt"
          fi
          
          # Buscar y copiar TODOS los PNG en results (fallback)
          echo "=== BUSCANDO ARCHIVOS PNG EN RESULTS ==="
          PNG_FILES=$(find results -name "*.png" -type f)
          if [ -n "$PNG_FILES" ]; then
            echo "âœ… Encontrados archivos PNG, copiando..."
            mkdir -p public/robot/screenshots
            find results -name "*.png" -type f -exec cp {} public/robot/screenshots/ \; 2>/dev/null || true
            echo "Total PNGs copiados: $(ls -la public/robot/screenshots/ | grep .png | wc -l)"
          else
            echo "âŒ No se encontraron archivos PNG"
          fi
          
          # Crear archivo de inventario para verificaciÃ³n
          echo "=== INVENTARIO DE ARCHIVOS ===" > public/robot/inventory.txt
          echo "Archivos HTML:" >> public/robot/inventory.txt
          ls -la public/robot/*.html 2>/dev/null >> public/robot/inventory.txt || echo "No hay HTMLs" >> public/robot/inventory.txt
          echo "" >> public/robot/inventory.txt
          echo "Archivos PNG:" >> public/robot/inventory.txt
          ls -la public/robot/*.png 2>/dev/null >> public/robot/inventory.txt || echo "No hay PNGs" >> public/robot/inventory.txt
          echo "" >> public/robot/inventory.txt
          echo "Directorios:" >> public/robot/inventory.txt
          ls -la public/robot/ | grep ^d >> public/robot/inventory.txt
          
          # VerificaciÃ³n final
          echo "=== VERIFICACIÃ“N FINAL ==="
          echo "Contenido de public/robot:"
          ls -la public/robot/
          echo "Archivos PNG en public/robot:"
          ls -la public/robot/*.png 2>/dev/null || echo "No hay PNGs en public/robot/"
          echo "Directorios en public/robot:"
          ls -la public/robot/ | grep ^d

      # Deploy a GitHub Pages
      - name: Deploy Reports
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public
          publish_branch: gh-pages
          force_orphan: true