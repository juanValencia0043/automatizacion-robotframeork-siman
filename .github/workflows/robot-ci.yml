name: Robot Framework CI

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment (sandbox/prod)"
        required: true
        default: "sandbox"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  robot-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Robot Framework tests
        env:
          CI: "true"
          BROWSER: chrome
          HEADLESS: "true"
        run: |
          python run_tests.py ${{ github.event.inputs.environment || 'sandbox' }}

      - name: Debug - List all results
        if: always()
        run: |
          echo "=== ESTRUCTURA DE DIRECTORIOS ==="
          ls -la results/
          echo "=== DIRECTORIO EXECUTIONS ==="
          ls -la results/executions/ || true
          echo "=== CONTENIDO DE results/executions/latest.txt ==="
          cat results/executions/latest.txt 2>/dev/null || echo "No existe latest.txt"
          echo "=== ARCHIVOS HTML ENCONTRADOS ==="
          find results -name "*.html" | head -20

      - name: Build Allure Report
        if: always()
        uses: simple-elf/allure-report-action@master
        with:
          allure_results: results/allure-results

      - name: Prepare GitHub Pages content
        if: always()
        run: |
          # Limpiar y crear directorio public
          rm -rf public
          mkdir -p public

          # Copiar la carpeta pages completa (esto incluye tu index.html)
          echo "Copiando carpeta pages..."
          if [ -d "pages" ]; then
            cp -r pages/* public/ 2>/dev/null || true
            echo "âœ… Carpeta pages copiada"
          fi

          # Copiar reporte de Allure
          echo "Copiando reporte de Allure..."
          if [ -d "allure-report" ]; then
            mkdir -p public/allure
            cp -r allure-report/* public/allure/ 2>/dev/null || true
            echo "âœ… Allure report copiado a public/allure/"
          fi

          # Copiar reportes de Robot Framework
          echo "Copiando reportes de Robot Framework..."
          mkdir -p public/robot

          # Buscar la Ãºltima ejecuciÃ³n usando latest.txt
          if [ -f "results/executions/latest.txt" ]; then
            LATEST=$(cat results/executions/latest.txt)
            echo "ðŸ“ Ãšltima ejecuciÃ³n: $LATEST"
            
            if [ -d "$LATEST" ]; then
              # Copiar toda la Ãºltima ejecuciÃ³n a public/robot/latest/
              echo "Copiando Ãºltima ejecuciÃ³n a public/robot/latest/"
              mkdir -p public/robot/latest
              cp -r "$LATEST"/* public/robot/latest/ 2>/dev/null || true
              
              # TambiÃ©n copiar a la raÃ­z de /robot para acceso directo
              cp "$LATEST/report.html" public/robot/report.html 2>/dev/null || true
              cp "$LATEST/log.html" public/robot/log.html 2>/dev/null || true
              
              echo "âœ… Reportes copiados correctamente"
              
              # Verificar screenshots
              if [ -d "$LATEST/screenshots" ]; then
                mkdir -p public/robot/latest/screenshots
                cp -r "$LATEST/screenshots"/* public/robot/latest/screenshots/ 2>/dev/null || true
                echo "ðŸ“¸ Screenshots copiados"
              fi
            else
              echo "âŒ El directorio $LATEST no existe"
            fi
          else
            echo "âŒ No se encontrÃ³ results/executions/latest.txt"
            
            # Fallback: buscar el directorio mÃ¡s reciente
            LATEST_DIR=$(find results/executions -name "report.html" -type f | xargs dirname | sort -r | head -1)
            if [ -n "$LATEST_DIR" ]; then
              echo "âœ… Usando directorio mÃ¡s reciente: $LATEST_DIR"
              mkdir -p public/robot/latest
              cp -r "$LATEST_DIR"/* public/robot/latest/ 2>/dev/null || true
              cp "$LATEST_DIR/report.html" public/robot/report.html 2>/dev/null || true
            fi
          fi

          # VerificaciÃ³n final
          echo "=== VERIFICACIÃ“N FINAL ==="
          echo "Contenido de public/:"
          ls -la public/
          echo ""
          echo "Contenido de public/robot/:"
          ls -la public/robot/ 2>/dev/null || echo "No hay directorio robot"
          echo ""
          echo "Contenido de public/robot/latest/:"
          ls -la public/robot/latest/ 2>/dev/null || echo "No hay directorio latest"
          echo ""
          echo "Total PNGs: $(find public -name "*.png" -type f 2>/dev/null | wc -l)"

      - name: Deploy Reports
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public
          publish_branch: gh-pages
          force_orphan: true
